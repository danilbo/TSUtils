<style>
  #performanceChart #performanceChart {
    display: inline-block;
    position: relative;
    width: 100%;
    margin: 10%;
  }
</style>

<div>
  <canvas id="performanceChart"></canvas>
</div>

<div>
  <canvas id="internetChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<script>

  // create initial empty chart
  var ctx_live = document.getElementById("performanceChart");
  var performanceChart = new Chart(ctx_live, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        data: [],
        borderWidth: 3,
        borderColor: '#00c0ef',
        label: 'CPU usage',
      },
      {
        data: [],
        borderWidth: 3,
        borderColor: '#FF0000',
        label: 'Memory usage',
      }
      ]
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: "Chart.js - Dynamically Update Chart Via Ajax Requests",
      },
      legend: {
        display: false
      },
      scales: {
        yAxes: [{
          ticks: {
            beginAtZero: true,
          }
        }]
      }
    }
  });

  // create initial empty chart
  var ctx_live = document.getElementById("internetChart");
  var internetChart = new Chart(ctx_live, {
    type: 'bar',
    data: {
      labels: [],
      datasets: []
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: "Chart.js - Dynamically Update Chart Via Ajax Requests",
      },
      legend: {
        display: false
      },
      scales: {
        yAxes: [{
          ticks: {
            beginAtZero: true,
          }
        }]
      }
    }
  });

  // this post id drives the data
  var postId = 1;
  // logic to get new data
  var getData = function () {
    $.ajax({
      url: '/api/v1/getData',
      success: function (data) {
        // process your data to pull out what you plan to use to update the chart
        // e.g. new label and a new data point

        // add new label and data point to chart's underlying data structures
        performanceChart.data.labels.push(postId++);
        performanceChart.data.datasets[0].data.push(data.cpuLoad);
        performanceChart.data.datasets[1].data.push(data.memory);

        performanceChart.update();


        let interfacesMap = createNewDatasets(data.interfaces);
        //internetChart.data.labels.push(postId++);
        let array = [];
        let labels = [];
        for (let element of interfacesMap.values()) {
          array.push(element);
          labels.push(element.label)
        }
        internetChart.data.datasets = array;
        internetChart.data.labels = labels;

        // re-render the chart
        internetChart.update();
      }
    });
  }

  var createNewDatasets = function (inputList) {
    let tmpInterfaces = new Map();

    for (let i = 0; i < internetChart.data.datasets.length; i++) {
      let currentDataset = internetChart.data.datasets[i];
      tmpInterfaces.set(currentDataset.label, currentDataset);
    }
    console.log("tmpInterfaces size: " + tmpInterfaces.size)
    console.log("inputList length: " + inputList.length)

    for (let i = 0; i < inputList.length; i++) {
      let currentInterface = inputList[i];
      console.log("currentInterface.label: " + currentInterface.label);
      if (tmpInterfaces.has(currentInterface.label)) {
        tmpInterfaces.get(currentInterface.label).data[0] = currentInterface.sent;
      } else {

        let tmpNewInterface = {
          data: [currentInterface.sent],
          label: currentInterface.label
        };
        console.log(tmpNewInterface);
        //if (tmpNewInterface.data > 0) {
          tmpInterfaces.set(currentInterface.label, tmpNewInterface);
        //}
      }
    }
    return tmpInterfaces;
  };



  // get new data every 5 seconds
  setInterval(getData, 1000);
</script>
 